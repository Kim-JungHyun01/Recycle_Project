<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}"
      layout:fragment="content">
<div class="collect_whole">
  <div >
    <form method="post" enctype="multipart/form-data" id="fileUploadForm">
      <p>파일</p>
      <input type="file" id="data_file" name="file"/>
      <input type="button" value="파일 업로드"/>
    </form>
    <!--여기에 요청 결과가 출력되어야 합니다.-->
    <div id="result_json"></div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript">

  var button = document.querySelector("input[type=button]");

  button.addEventListener("click", function(){
      var form = document.getElementById("fileUploadForm");
      var form_data = new FormData(form);
      button.disabled = true;

      var xhr = new XMLHttpRequest();
      var csrfToken = document.querySelector('meta[name="_csrf"]').content;
      var csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

      xhr.open("POST", "http://localhost:8080/image_service", true);// 이미지 자바서버
      xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF 토큰 설정

      xhr.onload = function(){
          if(xhr.status >=200 && xhr.status < 300){
              console.log(xhr.responseText);
              try{
                      // dict인 result_json div에 출력
                      var response = JSON.parse(xhr.responseText); //응답 json형태반환
                      var resultJsonDiv = document.getElementById("result_json");
                      resultJsonDiv.innerHTML = "<pre>" + JSON.stringify(response.json_data, null, 2) + "</pre>"; // predictions을 문자열로 변환하여 출력

                      button.disabled = false; //버튼활성화
                      alert("이미지전달");

                  }catch(e){
                      console.error("json 파싱오류 : "+e.message);
                      alert("응답데이터 처리중 오류가 발생");
                      button.disabled = false; //버튼활성화
                  }
          }else{
              console.error("ERROR : "+ xhr.statusText);
              alert("fail : "+xhr.statusText);
              button.disabled = false;
          }//end if
      }//end xhr.onload

      xhr.onerror = function(){
          console.error("ERROR : "+xhr.statusText);
          alert("fail : "+xhr.statusText);
          button.disabled = false;
      }//end xhr.onerror

      xhr.send(form_data);
  })//end button click
</script>

</html>